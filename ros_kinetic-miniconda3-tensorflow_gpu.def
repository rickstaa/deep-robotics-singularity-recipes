# Ros kinetic panda_auto_grasp singularity container recipe
Bootstrap: docker
From: osrf/ros:kinetic-desktop-full-xenial

%help
    singularity container with Ros kinetic, gazebo7 and all the other packages needed for the panda_auto_grasp package. Since the panda_auto_grasp package is still under development it is set to private. You therefore need the right git permissions for the singularity image to work.

%labels
    Maintainer: Rick Staa
    Github: https://github.com/rickstaa
    Version v1.0
    Type: Private

%post

    printf '
================= panda_autograsp_kinetic container =================
INFO: Setting up panda_autograsp_kinetic container. As three of the
repositories that are contained in this container are private you
will be asked for your github credentials three times at the start
of the building process.
=====================================================================
' > /dev/null

    ## Install packages ##
    apt update
    apt install -q -y\
        wget \
        less \
        vim \
        git-core \
        bash-completion \
        htop \
        ssh \
		tar \
		libevent-dev \
        libncurses-dev \
        tmux \
		nautilus \
        gedit \
        x11-xserver-utils \
        ssh \
        software-properties-common \
        curl \
        iputils-ping

    ## Install miniconda3 ##
    apt -qq update && apt -qq -y install curl bzip2 \
        && curl -sSL https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -o /tmp/miniconda.sh \
        && bash /tmp/miniconda.sh -bfp /opt/miniconda3 \
        && rm -rf /tmp/miniconda.sh \
        && conda install -q -y python=3 \
        && conda update conda \
        && rm -rf /var/lib/apt/lists/* /var/log/dpkg.log \
        && conda clean --all --yes

    ## Install MoveIt and check for panda_auto_grasp package dependencies
    rosdep update
    apt update
    apt dist-upgrade -y
    apt install -q -y ros-kinetic-catkin python-catkin-tools
    apt install -q -y ros-kinetic-moveit
    apt install -q -y \
       ros-kinetic-moveit-ros-move-group \
       ros-kinetic-controller-manager* \
       ros-kinetic-moveit* \
       ros-kinetic-effort-controllers \
       ros-kinetic-joint-trajectory-controller \
       ros-kinetic-gazebo-ros* \
       ros-kinetic-rviz* \
       ros-kinetic-joint-state-controller* \
       libboost-filesystem-dev \
       libjsoncpp-dev

    ### Copy .singularity_bashrc repository file from panda_autograsp_singularity_recipes repository ###
    bash -c "cd / \
        && git clone https://github.com/rickstaa/deep_robotics_singularity_recipes.git \
        && cp /deep_robotics_singularity_recipes/.singularity_bashrc /.singularity_bashrc \
        && cp /deep_robotics_singularity_recipes/.conda_init /.conda_init \
        && cat /.conda_init >> /.singularity_bashrc \
        && rm -rf /deep_robotics_singularity_recipes"

    ## Create conda tensorflow enviroment
    . /opt/miniconda3/etc/profile.d/conda.sh
    export PATH="/opt/miniconda3/bin:$PATH"
    conda create -q -y --name tf-gpu
    conda activate tf-gpu

    ## Install jupyter notebooks
    conda install -y tensorflow-gpu
    conda install -y jupyter

    ## Remove unused packages ##
    apt -q -y upgrade

%runscript

	## Run custom entrypoint BASH script ##
	OCI_CMD='/bin/bash'
	OCI_ARGS='-rcfile /.singularity_bashrc'
	SINGULARITY_OCI_RUN="${OCI_CMD} ${OCI_ARGS}"
	exec $SINGULARITY_OCI_RUN

%environment

    ## Change floating point format ##
    LC_NUMERIC="en_US.UTF-8"

    ## Add miniconda to path ##
    export PATH="$PATH:/opt/miniconda3/bin:"
